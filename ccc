/* ------------------------------------------------------------------
   Smart Replenishment â€“ app.js  â˜…2025-05-09 å®Œæ•´ä¿®æ­£ç‰ˆ
   1. ä¿®å¾©æŠ€è¡“åœ“åœˆ (.circle-item) hover / scale è·‘ç‰ˆ
   2. EmailJS çœŸå¯¦å¯„ä¿¡ï¼›è‹¥æœªè¨­å®šå‰‡è‡ªå‹• fallback åˆ°æ¨¡æ“¬ç™¼é€
   3. å…¶é¤˜åŠŸèƒ½èˆ‡å‹•ç•«ä¿æŒåŸæ¨£
------------------------------------------------------------------ */

/* --------- [A] å…¨å±€ç‹€æ…‹ --------- */
let isNavMenuOpen = false;
let currentSection = 'hero';
let isScrolling = false;

/* --------- [B] DOM é¸å– --------- */
const navbar      = document.getElementById('navbar');
const navToggle   = document.getElementById('nav-toggle');
const navMenu     = document.getElementById('nav-menu');
const backToTop   = document.getElementById('back-to-top');
const contactForm = document.getElementById('contact-form');
const circleItems = document.querySelectorAll('.circle-item');

/* --------- [C] EmailJS åˆå§‹åŒ– --------- */
const EMAIL_SERVICE_ID   = 'YOUR_SERVICE_ID';    // <-- TODO
const EMAIL_TEMPLATE_ID  = 'YOUR_TEMPLATE_ID';   // <-- TODO
const EMAIL_PUBLIC_KEY   = 'YOUR_PUBLIC_KEY';    // <-- TODO
const EMAIL_ENABLED      = EMAIL_SERVICE_ID !== 'YOUR_SERVICE_ID'; // ç°¡æ˜“åˆ¤æ–·

(function () {
  /* global emailjs */
  if (EMAIL_ENABLED && window.emailjs) {
    emailjs.init(EMAIL_PUBLIC_KEY);
    console.info('âœ… EmailJS åˆå§‹åŒ–å®Œæˆ');
  } else {
    console.warn('âš ï¸ å°šæœªé…ç½® EmailJSï¼Œå°‡ä½¿ç”¨æ¨¡æ“¬å¯„ä¿¡');
  }
})();

/* --------- [D] æ²å‹•ã€å°èˆªã€è¿”å›é ‚éƒ¨ --------- */
function handleNavbarScroll() {
  navbar.classList.toggle('scrolled', window.scrollY > 100);
}

function handleBackToTopVisibility() {
  backToTop.classList.toggle('show', window.scrollY > 500);
}

function updateCurrentSection() {
  const sections = [
    'hero','technology','subsidiaries','taiwan-analysis',
    'cases','scenarios','advantages','contact'
  ];
  const pos = window.scrollY + 200;
  for (let i = sections.length - 1; i >= 0; i--) {
    const s = document.getElementById(sections[i]);
    if (s && pos >= s.offsetTop) {
      currentSection = sections[i];
      document
        .querySelectorAll('.nav-link')
        .forEach(a => a.classList.toggle('active', a.getAttribute('href') === `#${s.id}`));
      break;
    }
  }
}

function handleScroll() {
  if (isScrolling) return;
  isScrolling = true;
  requestAnimationFrame(() => {
    handleNavbarScroll();
    handleBackToTopVisibility();
    updateCurrentSection();
    handleAOSAnimation();
    isScrolling = false;
  });
}

function toggleMobileMenu() {
  isNavMenuOpen = !isNavMenuOpen;
  navMenu.classList.toggle('active', isNavMenuOpen);
  navToggle.classList.toggle('active', isNavMenuOpen);
  document.body.style.overflow = isNavMenuOpen ? 'hidden' : '';
}

function smoothScrollTo(hash) {
  const target = document.querySelector(hash);
  if (!target) return;
  window.scrollTo({ top: target.offsetTop - 80, behavior: 'smooth' });
  if (isNavMenuOpen) toggleMobileMenu();
}

function setupNavigation() {
  document.querySelectorAll('.nav-link').forEach(link => {
    link.addEventListener('click', e => {
      e.preventDefault();
      smoothScrollTo(link.getAttribute('href'));
    });
  });
}

/* --------- [E] åœ“åœˆäº’å‹•ï¼ˆè·‘ç‰ˆä¿®è£œå·²æ•´åˆï¼‰ --------- */
function setupTechCircleInteractions() {
  const subsidiaries = [
    { name:'MEMSæ™ºèƒ½æ„Ÿæ¸¬', company:'CMC',  description:'å£“é˜»å¼å·®å£“æ„Ÿæ¸¬å™¨ Â±5 kPa' },
    { name:'AIæ±ºç­–å¹³å°',   company:'CiCS', description:'LSTM é æ¸¬ 98% æº–ç¢ºç‡' },
    { name:'æ™ºæ…§ç‰©æµèª¿åº¦', company:'CiLS', description:'Smart Move 3D æ„ŸçŸ¥' },
    { name:'AMRè‡ªå‹•åŸ·è¡Œ',  company:'CIRC', description:'500 kg Â±2 cm' },
    { name:'ARè¦–è¦ºæ ¡æ­£',  company:'CRI',  description:'Snapdragon XR2' }
  ];
  circleItems.forEach((item, idx) => {
    item.style.width = item.style.height = '100px';          // å›ºå®šå¤§å°
    item.style.borderRadius = '50%';
    item.style.transformOrigin = 'center';                   // é¿å… scale åç§»
    item.addEventListener('mouseenter', () => {
      circleItems.forEach(o => (o.style.opacity = o === item ? '1' : '0.5'));
      item.style.transform = 'scale(1.15)';
      document.querySelector('.tech-circle').style.animationPlayState = 'paused';
      showTechTooltip(item, subsidiaries[idx]);
    });
    item.addEventListener('mouseleave', () => {
      circleItems.forEach(o => (o.style.opacity = '1'));
      item.style.transform = 'scale(1)';
      document.querySelector('.tech-circle').style.animationPlayState = 'running';
      hideAllTooltips();
    });
    item.addEventListener('click', () => {
      smoothScrollTo('#subsidiaries');
      setTimeout(() => {
        const cards = document.querySelectorAll('.tech-card');
        cards[idx]?.scrollIntoView({ behavior:'smooth', block:'center' });
        highlightTechCard(cards[idx], subsidiaries[idx]);
      }, 800);
    });
  });
}

/* --------- [F] Email è¡¨å–®è™•ç† --------- */
function setupContactForm() {
  if (!contactForm) return;
  contactForm.addEventListener('submit', async e => {
    e.preventDefault();
    if (!validateForm()) {
      showNotification('è«‹å¡«å¯«æ‰€æœ‰å¿…å¡«æ¬„ä½ä¸¦ç¢ºèªé›»éƒµæ ¼å¼', 'error');
      return;
    }

    const submitBtn   = document.getElementById('submit-btn');
    submitBtn.classList.add('loading');
    submitBtn.disabled = true;

    const fd = new FormData(contactForm);
    const params = {
      from_name    : fd.get('name'),
      from_company : fd.get('company'),
      from_position: fd.get('position') || 'æœªæä¾›',
      from_phone   : fd.get('phone')    || 'æœªæä¾›',
      from_email   : fd.get('email'),
      inquiry_type : fd.get('inquiry_type'),
      message      : fd.get('message'),
      timestamp    : new Date().toLocaleString('zh-TW')
    };

    try {
      if (EMAIL_ENABLED) {
        await emailjs.send(EMAIL_SERVICE_ID, EMAIL_TEMPLATE_ID, params, EMAIL_PUBLIC_KEY);
      } else {
        await simulateEmailSend(params); // fallback
      }
      contactForm.classList.add('hidden');
      document.getElementById('form-success').classList.remove('hidden');
      showNotification('å·²æˆåŠŸé€å‡ºï¼æˆ‘å€‘å°‡ç›¡å¿«å›è¦†ã€‚', 'success');
      setTimeout(resetContactForm, 3000);
    } catch (err) {
      console.error(err);
      document.getElementById('form-error').classList.remove('hidden');
      showNotification('ç™¼é€å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚', 'error');
      setTimeout(() => {
        document.getElementById('form-error').classList.add('hidden');
        resetSubmitButton();
      }, 3000);
    }
  });
}

function simulateEmailSend(params) {
  return new Promise((res, rej) =>
    setTimeout(() => (Math.random() > 0.1 ? res() : rej(new Error('Simulated error'))), 1200)
  );
}

function validateForm() {
  const required = ['name','company','email','inquiry-type','message'];
  let ok = true;
  required.forEach(id => {
    const el = document.getElementById(id);
    if (!el || !el.value.trim()) {
      ok = false;
      el && (el.style.borderColor = '#f87171');
    }
  });
  const email = document.getElementById('email');
  const r = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  if (email && !r.test(email.value)) ok = false;
  return ok;
}
function resetContactForm() {
  document.getElementById('form-success').classList.add('hidden');
  contactForm.classList.remove('hidden');
  contactForm.reset();
  resetSubmitButton();
}
function resetSubmitButton() {
  const btn = document.getElementById('submit-btn');
  btn.classList.remove('loading');
  btn.disabled = false;
}

/* --------- [G] å…¶ä»–è¦–è¦ºã€é€šçŸ¥ç­‰åŸå§‹å‡½å¼ï¼ˆä¿æŒä¸è®Šï¼‰ --------- */
/*  â€¦â€¦ ä½ åŸå…ˆçš„å‡½å¼ï¼šshowNotification, handleAOSAnimation, addDynamicStyles,
       enhanceCardEffects, animateCounters, createScrollProgress, 
       setupFormValidation, setupKeyboardNavigation, debounce, etc.
       ï¼ˆé€™äº›å…§å®¹å·²åœ¨ä½ çš„åŸæª”ä¸­ï¼Œè«‹ç›´æ¥ä¿ç•™ï¼‰                         */

/* --------- [H] åˆå§‹åŒ– --------- */
function initializeApp() {
  setupNavigation();
  setupTechCircleInteractions();
  setupContactForm();
  setupFormValidation();
  enhanceCardEffects();
  setupKeyboardNavigation();
  // å…¶é¤˜åˆå§‹åŒ–ä¿æŒåŸæ¨£ â€¦
  createScrollProgress();
  animateCounters();
  addDynamicStyles();
  window.addEventListener('scroll', debounce(handleScroll, 10));
  navToggle.addEventListener('click', toggleMobileMenu);
  backToTop.addEventListener('click', () => window.scrollTo({ top: 0, behavior:'smooth' }));
  console.log('ğŸš€ App åˆå§‹å®Œæˆ');
}
document.readyState === 'loading'
  ? document.addEventListener('DOMContentLoaded', initializeApp)
  : initializeApp();

/* ------------------------------------------------------------------
   â–¸ CSS è¿½åŠ ï¼ˆå¯æ”¾å…¥ CSS æª”æˆ– <style>ï¼‰
.circle-item { width:100px;height:100px;border-radius:50%;
               transform-origin:center;flex-shrink:0;position:relative;}
.tech-circle { display:flex;flex-wrap:wrap;gap:24px;justify-content:center;}
------------------------------------------------------------------ */
